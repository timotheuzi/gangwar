{% extends "base.html" %}

{% block content %}
<div class="mud-fight-screen">
    <h2>⚔️ Combat ⚔️</h2>

    <!-- Upper area with combatant stats -->
    <div class="combat-status">
        <div class="player-status">
            <h4>Your Status</h4>
            <p>Health: {{ (game_state.health - game_state.damage) if game_state.health - game_state.damage > 0 else 0 }}/{{ game_state.health }}</p>
            <p>Money: ${{ "{:,}".format(game_state.money) }}</p>
            <p>Gang Members: {{ game_state.members }}</p>
        </div>

        <div class="enemy-status">
            <h4>Enemy Status</h4>
            <p>Health: {{ enemy_health }}/{{ max_enemy_hp }}</p>
            <p>Type: {{ enemy_type }}</p>
            {% if enemy_count > 1 %}
            <p>Enemies: {{ enemy_count }}</p>
            {% endif %}
        </div>
    </div>

    {% if combat_active %}
    <div class="combat-actions">
        <h3>Your Turn</h3>
        <form method="POST" action="{{ url_for('process_fight_action') }}">
            <input type="hidden" name="combat_id" value="{{ combat_id }}">
            <input type="hidden" name="enemy_type" value="{{ enemy_type }}">
            <input type="hidden" name="enemy_count" value="{{ enemy_count }}">
            <div class="action-buttons">
                <button type="submit" name="action" value="attack" class="btn btn-danger">Attack</button>
                <button type="submit" name="action" value="defend" class="btn btn-warning">Defend</button>
                <button type="submit" name="action" value="flee" class="btn btn-secondary">Flee (Risky)</button>
            </div>

            <div class="drug-options">
                <h4>⚡ Quick Drug Boost (Risky!)</h4>
                <p style="font-size: 12px; color: #666;">Drugs can boost your power but might backfire!</p>
                {% if game_state.drugs.weed > 0 %}
                <button type="submit" name="action" value="use_drug" formaction="{{ url_for('process_fight_action') }}?drug=weed" class="btn btn-success btn-small">Use Weed (+Speed, -Accuracy)</button>
                {% endif %}
                {% if game_state.drugs.crack > 0 %}
                <button type="submit" name="action" value="use_drug" formaction="{{ url_for('process_fight_action') }}?drug=crack" class="btn btn-success btn-small">Use Crack (+Power, -Health)</button>
                {% endif %}
                {% if game_state.drugs.coke > 0 %}
                <button type="submit" name="action" value="use_drug" formaction="{{ url_for('process_fight_action') }}?drug=coke" class="btn btn-success btn-small">Use Coke (+Accuracy, Risky)</button>
                {% endif %}
                {% if game_state.drugs.ice > 0 %}
                <button type="submit" name="action" value="use_drug" formaction="{{ url_for('process_fight_action') }}?drug=ice" class="btn btn-success btn-small">Use Ice (+Strength, -Control)</button>
                {% endif %}
                {% if game_state.drugs.percs > 0 %}
                <button type="submit" name="action" value="use_drug" formaction="{{ url_for('process_fight_action') }}?drug=percs" class="btn btn-success btn-small">Use Percs (+Pain Resistance, Drowsy)</button>
                {% endif %}
                {% if game_state.drugs.pixie_dust > 0 %}
                <button type="submit" name="action" value="use_drug" formaction="{{ url_for('process_fight_action') }}?drug=pixie_dust" class="btn btn-success btn-small">Use Pixie Dust (???)</button>
                {% endif %}
            </div>

            <div class="weapon-selection">
                <label for="weapon">Choose Weapon:</label>
                <select name="weapon" id="weapon">
                    {% if game_state.weapons.pistols > 0 and game_state.weapons.bullets > 0 %}
                    <option value="pistol">Pistol ({{ game_state.weapons.bullets }} bullets){% if game_state.weapons.pistol_automatic %} (Auto){% endif %} - 2 attacks/turn</option>
                    {% endif %}

                    {% if game_state.weapons.ar15 > 0 and game_state.weapons.bullets > 0 %}
                    <option value="ar15">AR-15 ({{ game_state.weapons.bullets }} bullets) - 1 attack/turn</option>
                    {% endif %}

                    {% if game_state.weapons.ghost_guns > 0 and game_state.weapons.bullets > 0 %}
                    <option value="ghost_gun">Ghost Gun ({{ game_state.weapons.bullets }} bullets){% if game_state.weapons.ghost_gun_automatic %} (Auto){% endif %} - 1 attack/turn</option>
                    {% endif %}

                    {% if game_state.weapons.grenades > 0 %}
                    <option value="grenade">Grenade ({{ game_state.weapons.grenades }} available) - 1 attack/turn</option>
                    {% endif %}

                    {% if game_state.weapons.missile_launcher > 0 and game_state.weapons.missiles > 0 %}
                    <option value="missile_launcher">Missile Launcher ({{ game_state.weapons.missiles }} missiles) - 1 attack/turn</option>
                    {% endif %}

                    {% if game_state.weapons.vampire_bat > 0 %}
                    <option value="vampire_bat">Vampire Bat - 2 attacks/turn</option>
                    {% endif %}

                    <option value="knife">Knife - 3 attacks/turn</option>
                </select>
            </div>

            <div class="ammo-selection">
                <label for="ammo">Special Ammo:</label>
                <select name="ammo" id="ammo">
                    <option value="normal">Normal Ammo</option>
                    {% if game_state.weapons.exploding_bullets > 0 and (game_state.weapons.pistols > 0 or game_state.weapons.ghost_guns > 0 or game_state.weapons.ar15 > 0) and game_state.weapons.bullets > 0 %}
                    <option value="exploding">Exploding Bullets ({{ game_state.weapons.exploding_bullets }} available) - Double Damage!</option>
                    {% endif %}
                </select>
            </div>
        </form>
    </div>
    {% endif %}

    <!-- Combat Log Section -->
    <div class="combat-chat-container">
        <div class="combat-chat-section">
            <h4>⚔️ Combat Log</h4>
            <div id="combat-messages" class="combat-messages">
                {% for line in fight_log %}
                <div class="combat-line">{{ line }}</div>
                {% endfor %}
            </div>
        </div>
    </div>

    <div class="combat-options">
        {% if not combat_active %}
            {% if encounter_context %}
                {% if encounter_context.type == 'wander' %}
                    <a href="{{ url_for('continue_activity') }}" class="btn btn-success">Continue Wandering</a>
                {% elif encounter_context.type == 'alleyway' %}
                    <a href="{{ url_for('continue_activity') }}" class="btn btn-success">Continue in Alleyway</a>
                {% endif %}
            {% endif %}
            <a href="{{ url_for('city') }}" class="btn btn-primary">Return to City</a>
        {% endif %}
    </div>
</div>

{% block chat %}
<!-- Combat page - no city chat -->
{% endblock %}

<style>
.combat-line {
    margin: 5px 0;
    padding: 5px;
    border-left: 3px solid #333;
    background-color: #000;
    font-family: 'Courier New', monospace;
    white-space: pre-wrap;
}

.fight-messages {
    max-height: 300px;
    overflow-y: hidden;
    border: 1px solid #ddd;
    padding: 10px;
    background-color: #000;
    color: #0f0;
    font-family: 'Courier New', monospace;
    font-size: 14px;
}

.weapon-selection {
    margin-top: 15px;
}

.weapon-selection select {
    margin-left: 10px;
    padding: 5px;
}

.combat-status {
    display: flex;
    justify-content: space-between;
    margin: 20px 0;
    gap: 20px;
}

.player-status, .enemy-status {
    flex: 1;
    padding: 15px;
    border: 1px solid var(--border-primary, #00ff00);
    border-radius: var(--radius-md, 8px);
    background: var(--secondary-bg, #333);
    box-shadow: var(--shadow-secondary, 0 4px 16px rgba(0, 0, 0, 0.3));
}

.player-status h4, .enemy-status h4 {
    color: var(--text-accent, #00ff00);
    margin-bottom: 10px;
    border-bottom: 1px solid var(--text-accent, #00ff00);
    padding-bottom: 5px;
}

.player-status p, .enemy-status p {
    color: var(--text-primary, #fff);
    margin: 5px 0;
}

.drug-options {
    margin-top: 15px;
    padding: 10px;
    border: 2px solid #daa520;
    border-radius: 8px;
    background-color: #000;
    box-shadow: 0 2px 4px rgba(0,0,0,0.1);
}

.drug-options h4 {
    margin-top: 0;
    color: #2e8b57;
    font-size: 14px;
}

.btn-small {
    font-size: 11px;
    padding: 4px 8px;
    margin: 2px;
    min-width: 120px;
}

/* Combat Chat Styles */
.combat-chat-container {
    margin: 15px 0;
}

.combat-chat-section {
    background-color: #333;
    padding: 8px;
    border: 1px solid #0088ff;
    max-height: 400px;
    display: flex;
    flex-direction: column;
}

.combat-chat-section h4 {
    color: #0088ff;
    margin-bottom: 12px;
    border-bottom: 1px solid #0088ff;
    padding-bottom: 4px;
}

.combat-messages {
    flex: 1;
    overflow-y: auto;
    background-color: #1a1a1a;
    border: 1px solid #555;
    padding: 8px;
    min-height: 200px;
    max-height: 300px;
    font-family: 'Courier New', monospace;
    font-size: 14px;
    color: #0f0;
}
</style>

<script>
// Combat log management
document.addEventListener('DOMContentLoaded', function() {
    initializeCombatLog();
});

function initializeCombatLog() {
    const combatMessages = document.getElementById('combat-messages');
    if (!combatMessages) return;

    // Limit initial messages if there are too many
    limitCombatMessages();

    // Scroll to bottom with a small delay to ensure content is rendered
    setTimeout(() => {
        scrollCombatToBottom();
    }, 100);
}

function addCombatMessage(message, messageClass) {
    const combatMessages = document.getElementById('combat-messages');
    if (!combatMessages) return;

    const messageDiv = document.createElement('div');
    messageDiv.className = 'combat-line';
    if (messageClass) {
        messageDiv.classList.add(messageClass);
    }
    messageDiv.innerHTML = message;

    combatMessages.appendChild(messageDiv);

    // Limit messages and scroll
    limitCombatMessages();
    scrollCombatToBottom();
}

function limitCombatMessages() {
    const combatMessages = document.getElementById('combat-messages');
    if (!combatMessages) return;

    const maxMessages = 50; // Maximum number of messages to keep

    while (combatMessages.children.length > maxMessages) {
        combatMessages.removeChild(combatMessages.firstChild); // Remove oldest message
    }
}

function scrollCombatToBottom() {
    const combatMessages = document.getElementById('combat-messages');
    if (combatMessages) {
        combatMessages.scrollTop = combatMessages.scrollHeight;
    }
}

// Function to clear combat log
function clearCombatLog() {
    const combatMessages = document.getElementById('combat-messages');
    if (combatMessages) {
        combatMessages.innerHTML = '';
    }
}

// Make functions globally available
window.addCombatMessage = addCombatMessage;
window.clearCombatLog = clearCombatLog;
window.scrollCombatToBottom = scrollCombatToBottom;
</script>
{% endblock %}
