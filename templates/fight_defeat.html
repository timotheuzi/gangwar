{% extends "base.html" %}

{% block content %}
<div class="fight-defeat-screen">
    <h2>ðŸ’€ FIGHT DEFEAT ðŸ’€</h2>

    <div class="defeat-message">
        <h3>You've Been Defeated!</h3>
        {% if game_state.lives > 0 %}
        <p>You lost the fight and took fatal damage. You've lost a life!</p>
        <p>Lives remaining: <strong>{{ game_state.lives }}</strong></p>
        {% else %}
        <p>You lost the fight and took fatal damage. You've run out of lives!</p>
        <p><strong>GAME OVER</strong></p>
        {% endif %}
    </div>

    <div class="fight-summary">
        <h3>Fight Summary</h3>
        <div class="summary-details">
            <p><strong>Opponent:</strong> {{ enemy_type }}</p>
            {% if enemy_count > 1 %}
            <p><strong>Number of Enemies:</strong> {{ enemy_count }}</p>
            {% endif %}
            <p><strong>Final Damage Taken:</strong> {{ final_damage }}</p>
        </div>

        {% if fight_log %}
        <div class="combat-log">
            <h4>Combat Log:</h4>
            <div class="log-entries">
                {% for entry in fight_log[-5:] %}  {# Show last 5 entries #}
                <p>{{ entry }}</p>
                {% endfor %}
            </div>
        </div>
        {% endif %}
    </div>

    <div class="defeat-details">
        <h3>What Happened</h3>
        <p>Your health was depleted in combat. You were overwhelmed by your enemies.</p>
        {% if game_state.lives > 0 %}
        <p>You've been revived in the city with full health, but you're one step closer to total defeat.</p>
        {% else %}
        <p>This was your final life. Your gang's reign has come to an end.</p>
        {% endif %}
    </div>

    <div class="current-stats">
        <h3>Your Current Status</h3>
        <div class="stats-grid">
            <div class="stat-item">
                <p>Health: {{ game_state.health }}/100</p>
                <p>Money: ${{ "{:,}".format(game_state.money) }}</p>
                <p>Gang Members: {{ game_state.members }}</p>
            </div>
            <div class="stat-item">
                <p>Day: {{ game_state.day }}</p>
                <p>Steps Today: {{ game_state.steps }}/{{ game_state.max_steps }}</p>
                <p>Current Score: {{ game_state.current_score }}</p>
            </div>
        </div>
    </div>

    {% if game_state.lives > 0 %}
    <div class="warning">
        <h3>Warning</h3>
        <p>If you lose all your lives, the game will be over permanently!</p>
        <p>Be more careful in future fights. Consider buying better weapons or recruiting more members.</p>
    </div>

    <div class="actions">
        <p>Returning to city in <span id="countdown">3</span> seconds...</p>
        <a href="{{ url_for('city') }}" class="btn btn-primary">Return to City Now</a>
    </div>
    {% else %}
    <div class="actions">
        <p>Redirecting to game over in <span id="countdown">3</span> seconds...</p>
        <a href="{{ url_for('game_over') }}" class="btn btn-danger">View Game Over</a>
    </div>
    {% endif %}
</div>

{% if game_state.lives > 0 %}
<script>
    let countdown_city = 3;
    const countdownElement_city = document.getElementById('countdown');

    const timer_city = setInterval(() => {
        countdown_city--;
        countdownElement_city.textContent = countdown_city;

        if (countdown_city <= 0) {
            clearInterval(timer_city);
            window.location.href = "{{ url_for('city') }}";
        }
    }, 1000);
</script>
{% else %}
<script>
    let countdown_gameover = 3;
    const countdownElement_gameover = document.getElementById('countdown');

    const timer_gameover = setInterval(() => {
        countdown_gameover--;
        countdownElement_gameover.textContent = countdown_gameover;

        if (countdown_gameover <= 0) {
            clearInterval(timer_gameover);
            window.location.href = "{{ url_for('game_over') }}";
        }
    }, 1000);
</script>
{% endif %}

<style>
.fight-defeat-screen {
    max-width: 800px;
    margin: 0 auto;
    padding: 20px;
    text-align: center;
}

.defeat-message {
    background: rgba(255, 0, 0, 0.1);
    border: 2px solid #ff0000;
    border-radius: 10px;
    padding: 20px;
    margin: 20px 0;
}

.defeat-details, .current-stats, .warning {
    background: rgba(0, 0, 0, 0.1);
    border-radius: 10px;
    padding: 15px;
    margin: 15px 0;
}

.stats-grid {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 15px;
    margin-top: 10px;
}

.stat-item {
    background: rgba(255, 255, 255, 0.1);
    padding: 10px;
    border-radius: 5px;
}

.actions {
    margin-top: 30px;
}

#countdown {
    font-size: 24px;
    font-weight: bold;
    color: #ff0000;
}
</style>
{% endblock %}
