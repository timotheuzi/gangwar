{% extends "base.html" %}

{% block content %}
<div class="mud-fight-screen">
    <h2>‚öîÔ∏è Combat ‚öîÔ∏è</h2>

    <!-- Upper area with combatant stats -->
    <div class="combat-status">
        <div class="player-status">
            <h4>Your Status</h4>
            <p>Health: {{ game_state.health - game_state.damage }}/30</p>
            <p>Money: ${{ "{:,}".format(game_state.money) }}</p>
            <p>Gang Members: {{ game_state.members }}</p>
        </div>

        <div class="enemy-status">
            <h4>Enemy Status</h4>
            <p>Health: {{ enemy_health }}/10</p>
            <p>Type: {{ enemy_type }}</p>
            {% if enemy_count > 1 %}
            <p>Enemies: {{ enemy_count }}</p>
            {% endif %}
        </div>
    </div>

    <!-- Fight Information Window -->
    <div class="fight-info-window">
        <h3>‚öîÔ∏è Combat Log ‚öîÔ∏è</h3>
        <div class="fight-log-container">
            {% if fight_log %}
                {% for entry in fight_log %}
                <div class="fight-log-entry">
                    <span class="turn-marker">></span>
                    <span class="turn-text">{{ entry }}</span>
                </div>
                {% endfor %}
            {% else %}
                <div class="fight-log-entry">
                    <span class="turn-marker">></span>
                    <span class="turn-text">Combat begins against {{ enemy_type }}!</span>
                </div>
            {% endif %}
        </div>
    </div>

    {% if combat_active %}
    <div class="combat-actions">
        <h3>Your Turn</h3>
        <form method="POST" action="{{ url_for('process_fight_action') }}">
            <input type="hidden" name="combat_id" value="{{ combat_id }}">
            <div class="action-buttons">
                <button type="submit" name="action" value="attack" class="btn btn-danger">Attack</button>
                <button type="submit" name="action" value="defend" class="btn btn-warning">Defend</button>
                <button type="submit" name="action" value="change_weapon" class="btn btn-info">Change Weapon</button>
                <button type="submit" name="action" value="flee" class="btn btn-secondary">Flee (Risky)</button>
            </div>

            <div class="drug-options">
                <h4>‚ö° Quick Drug Boost (Risky!)</h4>
                <p style="font-size: 12px; color: #666;">Drugs can boost your power but might backfire!</p>
                {% if game_state.drugs.weed > 0 %}
                <button type="submit" name="action" value="use_drug" formaction="{{ url_for('process_fight_action') }}?drug=weed" class="btn btn-success btn-small">Use Weed (+Speed, -Accuracy)</button>
                {% endif %}
                {% if game_state.drugs.crack > 0 %}
                <button type="submit" name="action" value="use_drug" formaction="{{ url_for('process_fight_action') }}?drug=crack" class="btn btn-success btn-small">Use Crack (+Power, -Health)</button>
                {% endif %}
                {% if game_state.drugs.coke > 0 %}
                <button type="submit" name="action" value="use_drug" formaction="{{ url_for('process_fight_action') }}?drug=coke" class="btn btn-success btn-small">Use Coke (+Accuracy, Risky)</button>
                {% endif %}
                {% if game_state.drugs.ice > 0 %}
                <button type="submit" name="action" value="use_drug" formaction="{{ url_for('process_fight_action') }}?drug=ice" class="btn btn-success btn-small">Use Ice (+Strength, -Control)</button>
                {% endif %}
                {% if game_state.drugs.percs > 0 %}
                <button type="submit" name="action" value="use_drug" formaction="{{ url_for('process_fight_action') }}?drug=percs" class="btn btn-success btn-small">Use Percs (+Pain Resistance, Drowsy)</button>
                {% endif %}
                {% if game_state.drugs.pixie_dust > 0 %}
                <button type="submit" name="action" value="use_drug" formaction="{{ url_for('process_fight_action') }}?drug=pixie_dust" class="btn btn-success btn-small">Use Pixie Dust (???)</button>
                {% endif %}
            </div>

            <div class="weapon-selection">
                <label for="weapon">Choose Weapon:</label>
                <select name="weapon" id="weapon">
                    {% if game_state.weapons.pistols > 0 and game_state.weapons.bullets > 0 %}
                    <option value="pistol">Pistol ({{ game_state.weapons.bullets }} bullets) - 2 attacks/turn</option>
                    {% endif %}
                    {% if game_state.weapons.uzis > 0 and game_state.weapons.bullets >= 3 %}
                    <option value="uzi">Uzi ({{ game_state.weapons.bullets }} bullets) - 4 attacks/turn</option>
                    {% endif %}
                    {% if game_state.weapons.grenades > 0 %}
                    <option value="grenade">Grenade ({{ game_state.weapons.grenades }} available) - 1 attack/turn</option>
                    {% endif %}
                    {% if game_state.weapons.missile_launcher > 0 and game_state.weapons.missiles > 0 %}
                    <option value="missile_launcher">Missile Launcher ({{ game_state.weapons.missiles }} missiles) - 1 attack/turn</option>
                    {% endif %}
                    {% if game_state.weapons.vampire_bat > 0 %}
                    <option value="vampire_bat">Vampire Bat - 2 attacks/turn</option>
                    {% endif %}
                    {% if game_state.weapons.ghost_guns > 0 and game_state.weapons.bullets > 0 %}
                    <option value="ghost_gun">Ghost Gun ({{ game_state.weapons.bullets }} bullets) - 1 attack/turn</option>
                    {% endif %}
                    <option value="knife">Knife - 3 attacks/turn</option>
                </select>
            </div>
        </form>
    </div>
    {% endif %}



    <div class="combat-options">
        {% if not combat_active %}
            {% if victory %}
                <div class="victory-outcome">
                    <h3>üéâ VICTORY! üéâ</h3>
                    <p>You have successfully defeated your enemies!</p>
                    {% if fight_log %}
                        <div class="victory-log">
                            <h4>Combat Summary:</h4>
                            {% for entry in fight_log %}
                                <div class="log-entry">{{ entry }}</div>
                            {% endfor %}
                        </div>
                    {% endif %}
                    <div class="continue-options">
                        <form method="POST" action="{{ url_for('continue_after_fight') }}">
                            <input type="hidden" name="outcome" value="victory">
                            <input type="hidden" name="combat_id" value="{{ combat_id }}">
                            <button type="submit" class="btn btn-success">Continue</button>
                        </form>
                    </div>
                </div>
            {% elif defeat %}
                <div class="defeat-outcome">
                    <h3>üíÄ DEFEAT! üíÄ</h3>
                    <p>You have been defeated in combat!</p>
                    {% if fight_log %}
                        <div class="defeat-log">
                            <h4>Combat Summary:</h4>
                            {% for entry in fight_log %}
                                <div class="log-entry">{{ entry }}</div>
                            {% endfor %}
                        </div>
                    {% endif %}
                    <div class="continue-options">
                        <form method="POST" action="{{ url_for('continue_after_fight') }}">
                            <input type="hidden" name="outcome" value="defeat">
                            <input type="hidden" name="combat_id" value="{{ combat_id }}">
                            <button type="submit" class="btn btn-danger">Continue</button>
                        </form>
                    </div>
                </div>
            {% else %}
                {% if encounter_context %}
                    {% if encounter_context.type == 'wander' %}
                        <a href="{{ url_for('continue_activity') }}" class="btn btn-success">Continue Wandering</a>
                    {% elif encounter_context.type == 'alleyway' %}
                        <a href="{{ url_for('continue_activity') }}" class="btn btn-success">Continue in Alleyway</a>
                    {% endif %}
                {% endif %}
                <a href="{{ url_for('city') }}" class="btn btn-primary">Return to City</a>
            {% endif %}
        {% endif %}
    </div>
</div>

{% block chat %}
<!-- Combat page - no city chat -->
{% endblock %}

<style>
.combat-line {
    margin: 5px 0;
    padding: 5px;
    border-left: 3px solid #333;
    background-color: #000;
    font-family: 'Courier New', monospace;
    white-space: pre-wrap;
}

.fight-messages {
    max-height: 300px;
    overflow-y: hidden;
    border: 1px solid #ddd;
    padding: 10px;
    background-color: #000;
    color: #0f0;
    font-family: 'Courier New', monospace;
    font-size: 14px;
}

.weapon-selection {
    margin-top: 15px;
}

.weapon-selection select {
    margin-left: 10px;
    padding: 5px;
}

.combat-status {
    display: flex;
    justify-content: space-between;
    margin: 20px 0;
    gap: 20px;
}

.player-status, .enemy-status {
    flex: 1;
    padding: 15px;
    border: 1px solid var(--border-primary, #00ff00);
    border-radius: var(--radius-md, 8px);
    background: var(--secondary-bg, #333);
    box-shadow: var(--shadow-secondary, 0 4px 16px rgba(0, 0, 0, 0.3));
}

.player-status h4, .enemy-status h4 {
    color: var(--text-accent, #00ff00);
    margin-bottom: 10px;
    border-bottom: 1px solid var(--text-accent, #00ff00);
    padding-bottom: 5px;
}

.player-status p, .enemy-status p {
    color: var(--text-primary, #fff);
    margin: 5px 0;
}

.drug-options {
    margin-top: 15px;
    padding: 10px;
    border: 2px solid #daa520;
    border-radius: 8px;
    background-color: #000;
    box-shadow: 0 2px 4px rgba(0,0,0,0.1);
}

.drug-options h4 {
    margin-top: 0;
    color: #2e8b57;
    font-size: 14px;
}

.btn-small {
    font-size: 11px;
    padding: 4px 8px;
    margin: 2px;
    min-width: 120px;
}

/* Fight Information Window Styles */
.fight-info-window {
    margin: 20px 0;
    padding: 15px;
    border: 2px solid var(--border-primary, #00ff00);
    border-radius: var(--radius-md, 8px);
    background: var(--secondary-bg, #111);
    box-shadow: var(--shadow-secondary, 0 4px 16px rgba(0, 0, 0, 0.3));
}

.fight-info-window h3 {
    color: var(--text-accent, #00ff00);
    margin-bottom: 15px;
    border-bottom: 1px solid var(--text-accent, #00ff00);
    padding-bottom: 5px;
    text-align: center;
}

.fight-log-container {
    max-height: 300px;
    overflow-y: auto;
    background-color: #000;
    border: 1px solid #333;
    padding: 10px;
    font-family: 'Courier New', monospace;
    font-size: 14px;
    color: #0f0;
    scrollbar-width: thin;
    scrollbar-color: #00ff00 #000;
}

.fight-log-container::-webkit-scrollbar {
    width: 8px;
}

.fight-log-container::-webkit-scrollbar-track {
    background: #000;
}

.fight-log-container::-webkit-scrollbar-thumb {
    background: #00ff00;
    border-radius: 4px;
}

.fight-log-container::-webkit-scrollbar-thumb:hover {
    background: #00cc00;
}

.fight-log-entry {
    margin: 8px 0;
    padding: 5px 0;
    border-bottom: 1px solid #333;
    display: flex;
    align-items: flex-start;
    gap: 10px;
}

.fight-log-entry:last-child {
    border-bottom: none;
}

.turn-marker {
    color: var(--text-accent, #00ff00);
    font-weight: bold;
    flex-shrink: 0;
    margin-top: 2px;
}

.turn-text {
    color: var(--text-primary, #fff);
    line-height: 1.4;
    word-wrap: break-word;
}

/* Combat Chat Styles */
.combat-chat-container {
    margin: 15px 0;
}

.combat-chat-section {
    background-color: #333;
    padding: 8px;
    border: 1px solid #0088ff;
    max-height: 400px;
    display: flex;
    flex-direction: column;
}

.combat-chat-section h4 {
    color: #0088ff;
    margin-bottom: 12px;
    border-bottom: 1px solid #0088ff;
    padding-bottom: 4px;
}

.combat-messages {
    flex: 1;
    overflow-y: auto;
    background-color: #1a1a1a;
    border: 1px solid #555;
    padding: 8px;
    min-height: 200px;
    max-height: 300px;
    font-family: 'Courier New', monospace;
    font-size: 14px;
    color: #0f0;
}
</style>


{% endblock %}
